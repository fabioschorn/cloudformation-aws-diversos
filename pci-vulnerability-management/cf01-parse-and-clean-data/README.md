# PCI Vulnerability Management: Parse and Clean Data

This CloudFormation template is designed to set up the necessary AWS resources to process and clean Qualys CSV vulnerability data, specifically focusing on PCI vulnerabilities. The architecture includes an IAM role and a Lambda function that processes CSV files stored in an existing S3 bucket.

## Architecture Overview

- **IAM Role**: Grants the Lambda function permissions to interact with the specified S3 bucket and utilize AWS Key Management Service (KMS) for encryption and decryption tasks.

- **Lambda Function**: Processes CSV files by:
  - Identifying the most recent CSV file in the `input-unprocessed/` directory of the S3 bucket.
  - Skipping the first 8 lines of the file.
  - Reading the remaining content with a semicolon (`;`) delimiter.
  - Retaining specific columns: `IP`, `DNS`, `OS`, `QID`, `Title`, `Severity`, `CVE ID`, `Vendor Reference`, `Threat`, `Impact`, `Solution`, `PCI Vuln`, and `Category`.
  - Splitting the data into two separate CSV files based on the `PCI Vuln` column:
    - Rows with `PCI Vuln` set to 'yes' are saved to the `output-processed/pci/` directory.
    - Rows with `PCI Vuln` set to 'no' are saved to the `output-processed/non-pci/` directory.

## Prerequisites

- An existing S3 bucket named `vm-analysis-project-poc02` with the following directories:
  - `input-unprocessed/`
  - `output-processed/pci/`
  - `output-processed/non-pci/`

## Resources Created

1. **IAM Role (`LambdaExecutionRole`)**:
   - Allows the Lambda function to assume the role.
   - Grants permissions to:
     - Read from and write to the specified S3 bucket.
     - Perform KMS operations such as decrypting and encrypting data.

2. **Lambda Function (`VMAnalysisLambda`)**:
   - Triggered manually or by an S3 event (if configured).
   - Executes the CSV processing logic as described above.
   - Configured with environment variables, including the S3 bucket name.

## Deployment Instructions

1. Ensure the S3 bucket `vm-analysis-project-poc02` exists with the required directory structure.
2. Deploy the CloudFormation template using the AWS Management Console, AWS CLI, or any Infrastructure as Code (IaC) tool that supports CloudFormation.
3. After deployment, upload a Qualys CSV file to the `input-unprocessed/` directory of the S3 bucket.
4. Manually invoke the Lambda function or set up an S3 event trigger to automate the process.

## Notes

- The Lambda function is configured with a timeout of 300 seconds to accommodate the processing of larger CSV files.
- Ensure that the Lambda function's execution role has the necessary permissions to access the S3 bucket and perform KMS operations.
- The template assumes that the S3 bucket and Lambda function are in the same AWS region.